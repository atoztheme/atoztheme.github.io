<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>W - 오늘 날씨</title>
    <!-- google icon -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- google font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" />
    <!-- style -->
    <link rel="stylesheet" href="css/style.css" />
    <!-- vue -->
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.js"></script>
  </head>
  <body>
    <div id="app" class="app" v-cloak>
      <main :class="`bg-${getTimePeriodKey()}`">
        <header>
          <h1>W</h1>
          <button
            class="material-symbols-outlined icon-location"
            aria-label="현재 위치 갱신"
            @click="getCurrentLocation"
          >
            my_location
          </button>
        </header>

        <section v-if="weather" class="weather">
          <div class="content">
            <h2 class="city">
              <span class="blind">지역</span>
              {{ weather.name }}
            </h2>
            <p class="description">
              {{ weather.weather[0].description }}
              <span class="material-symbols-outlined weather-icon" aria-hidden="true">
                {{ getWeatherIcon(weather.weather[0].icon) }}
              </span>
            </p>
            <p class="temp">
              <span class="blind">온도</span>
              {{ weather.main.temp }}°
            </p>
            <p class="humidity">
              <span class="blind">습도</span>
              <span class="material-symbols-outlined" aria-hidden="true"> humidity_high </span>
              {{ weather.main.humidity }}%
            </p>
          </div>

          <div class="bottom">
            <p>
              <span class="blind">일출</span>
              <span class="material-symbols-outlined sunrise" aria-hidden="true"> clear_day </span>
              {{ formatTime(weather.sys.sunrise) }}
            </p>
            <p>
              <span class="blind">일몰</span>
              <span class="material-symbols-outlined sunset" aria-hidden="true"> wb_twilight </span>
              {{ formatTime(weather.sys.sunset) }}
            </p>
          </div>
        </section>

        <section v-else class="weather">
          <p v-if="error" style="color: red">{{ error }}</p>
          <p v-else>날씨 정보를 불러오는 중...</p>
        </section>
      </main>
    </div>

    <script type="module">
      import { useTime } from './useTime.js';
      import { useWeather } from './useWeather.js';
      const { createApp, ref, watch, onMounted } = Vue;

      const { currentDate, getTimePeriodKey, formatTime } = useTime();
      const { weather, error, getCurrentLocation, getWeatherIcon } = useWeather();

      createApp({
        setup() {
          // 정각 마다 날씨 갱신
          const scheduleNextHourlyUpdate = () => {
            const now = new Date();
            const msUntilNextHour =
              (60 - now.getMinutes()) * 60 * 1000 - now.getSeconds() * 1000 - now.getMilliseconds();
            setTimeout(() => {
              getCurrentLocation();
              scheduleNextHourlyUpdate();
            }, msUntilNextHour);
          };

          onMounted(() => {
            getCurrentLocation();
            // 정시마다 날씨 갱신
            scheduleNextHourlyUpdate();
          });

          return {
            weather,
            error,
            currentDate,
            formatTime,
            getWeatherIcon,
            getTimePeriodKey,
            getCurrentLocation
          };
        }
      }).mount('#app');
    </script>
  </body>
</html>
