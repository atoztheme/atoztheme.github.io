<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STOP WATCH</title>
    <!-- google font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" />
    <!-- style -->
    <link rel="stylesheet" href="css/style.css" />
    <!-- vue -->
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.js"></script>
  </head>
  <body>
    <div id="app" v-cloak>
      <main :class="{'recode-mode': isViewRecode}">
        <time-display :time="totalRecode" :pad="pad" class="stop-watch"></time-display>

        <div class="btn-group">
          <button class="btn btn-gray" @click="toggleRecordReset">{{isStart ? 'RECORD' : 'RESET'}}</button>
          <button class="btn btn-primary" :class="{ active: isStart}" @click="toggleTimer">
            {{isStart ? 'STOP': 'START'}}
          </button>
        </div>

        <div class="recode">
          <div v-if="isViewRecode" class="title">
            <span class="col">NO</span>
            <span class="col">INTERVAL</span>
            <span class="col">TOTAL</span>
          </div>
          <ul v-if="isViewRecode">
            <li v-for="(recode, i) in reversedRecodeList" :key="recode.id">
              <div class="col">
                <span class="num">{{pad(recodeList.length - i)}}</span>
              </div>
              <div class="col">
                <time-display :time="recode.intervalRecode" :pad="pad" class="interval-recode"></time-display>
              </div>
              <div class="col">
                <time-display :time="recode.totalRecode" :pad="pad" class="total-recode"></time-display>
              </div>
            </li>
          </ul>
        </div>
      </main>
    </div>

    <script type="module">
      import TimeDisplay from './TimeDisplay.js';
      // 구조 분해 할당 : 객체/배열에서 값을 추출하여 새로운 변수 선언
      const { createApp, onUnmounted, ref, computed } = Vue;
      // 두자리 수 문자열 반환
      const pad = (n, length = 2) => String(n).padStart(length, '0');
      // 초, 밀리세컨즈 최대값 상수
      const MAX_TIME = {
        SECONDS: 59,
        MILLISECONDS: 99
      };
      // 10ms마다
      const TIMER_DELAY = 10;

      createApp({
        components: { TimeDisplay },
        setup() {
          const isStart = ref(false);
          const INIT_TIME = { minutes: 0, seconds: 0, milliseconds: 0 };
          // 스프레드 문법 : 새로운 객체를 생성하면서 기존 객체의 속성들을 그 새로운 객체에 복사
          const totalRecode = ref({ ...INIT_TIME });
          const intervalRecode = ref({ ...INIT_TIME });
          const recodeList = ref([]);
          let timer = null;

          // 기록 역순 정렬
          const reversedRecodeList = computed(() => {
            return recodeList.value.slice().reverse();
          });

          // 레코드 표시 여부
          const isViewRecode = computed(() => {
            return recodeList.value.length > 0;
          });

          // 타이머 시작
          const startTimer = () => {
            timer = setInterval(() => {
              intervalRecode.value.milliseconds++;
              totalRecode.value.milliseconds++;
              // ms가 100이되면 초 증가
              if (totalRecode.value.milliseconds > MAX_TIME.MILLISECONDS) {
                intervalRecode.value.milliseconds = 0;
                intervalRecode.value.seconds++;
                totalRecode.value.milliseconds = 0;
                totalRecode.value.seconds++;
              }
              // 60초가 되면 분 증가
              if (totalRecode.value.seconds > MAX_TIME.SECONDS) {
                intervalRecode.value.seconds = 0;
                intervalRecode.value.minutes++;
                totalRecode.value.seconds = 0;
                totalRecode.value.minutes++;
              }
            }, TIMER_DELAY);
          };

          // 타이머 시작 / 멈춤
          const toggleTimer = () => {
            if (isStart.value) {
              clearInterval(timer);
              timer = null;
            } else {
              startTimer();
            }
            isStart.value = !isStart.value;
          };

          // 타이머 기록 / 초기화
          const toggleRecordReset = () => {
            if (isStart.value) {
              // 타이머가 실행 중일 때 기록
              recodeList.value.push({
                // 고유 ID 추가 (성능 최적화 및 key 속성 사용 위함)
                id: Date.now() + Math.random(),
                intervalRecode: { ...intervalRecode.value },
                totalRecode: { ...totalRecode.value }
              });
              // 구간 기록 초기화
              intervalRecode.value = { ...INIT_TIME };
            } else {
              // 타이머가 멈춰있을 때 초기화
              intervalRecode.value = { ...INIT_TIME };
              totalRecode.value = { ...INIT_TIME };
              recodeList.value = [];
            }
          };

          // 컴포넌트 언마운트 시 타이머 정리 (메모리 누수 방지)
          onUnmounted(() => {
            if (timer) {
              clearInterval(timer);
            }
          });

          return {
            totalRecode,
            recodeList,
            reversedRecodeList,
            isViewRecode,
            isStart,
            toggleRecordReset,
            toggleTimer,
            pad
          };
        }
      }).mount('#app');
    </script>
  </body>
</html>
